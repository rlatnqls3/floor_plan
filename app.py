import streamlit as st
from streamlit_image_coordinates import streamlit_image_coordinates
from PIL import Image, ImageDraw
import numpy as np
import heapq
from collections import deque

# --- 1. í˜ì´ì§€ ì„¤ì • ---
st.set_page_config(page_title="SIK 2025 ìŠ¤ë§ˆíŠ¸ ë‚´ë¹„ê²Œì´ì…˜", page_icon="ğŸ¨", layout="wide")

st.markdown("""
    <style>
    .main-header { font-size: 2rem; font-weight: bold; color: #FF4B4B; }
    .stButton>button { width: 100%; border-radius: 8px; background-color: #FF4B4B; color: white; font-weight: bold;}
    .coord-box { background-color: #f0f2f6; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-family: monospace;}
    </style>
    """, unsafe_allow_html=True)

# --- 2. ì „ì²´ ë¶€ìŠ¤ ë°ì´í„° ---
# [Tip] ì´ì œ ë¶€ìŠ¤ ì •ì¤‘ì•™(ìƒ‰ê¹” ìœ„)ì„ ì¢Œí‘œë¡œ ì°ì–´ë„ ë©ë‹ˆë‹¤! AIê°€ ì•Œì•„ì„œ ì•ìª½ í†µë¡œë¡œ ì•ˆë‚´í•©ë‹ˆë‹¤.
BOOTH_LOCATIONS = {
    # ================= [ì£¼ìš” ì‹œì„¤] =================
    "ì¶œì…êµ¬ (Entrance)": (500, 950),
    "ì¹´í˜í…Œë¦¬ì•„ (Cafeteria)": (100, 150),
    "í™”ì¥ì‹¤ (Restroom)": (950, 500),
    "ìˆ˜ìœ ì‹¤": (900, 100),
    "ê²½í’ˆìˆ˜ë ¹ì²˜": (450, 900),

    # ================= [ê¸°íšê´€] =================
    "ìºë¦¬ì»¤ì³ ê¸°íšê´€": (200, 150),
    "ë””ì €íŠ¸íŒì—…ì¡´": (150, 400),
    "ì•„íŠ¸ì‘ê°€ ì´ˆëŒ€ì „": (150, 600),
    "ë°€ë¦¬ ì´ë²¤íŠ¸ì¡´": (300, 150),
    "ê¸€ë¡œë²Œ ì•„í‹°ìŠ¤íŠ¸ì¡´": (400, 100),
    "ë¨¸ìŠ¤ ê¸°íšê´€": (500, 100),
    "ì˜¤ëŠ˜ì˜ ì„¸ê³„(ì›í™”ì „)": (600, 100),
    "ë‚˜ì˜ ì¼ëŸ¬ìŠ¤íŠ¸ë ˆì´ì…˜ ì´ì•¼ê¸°": (650, 100),
    "ë„¤ì»·í”„ë ˆì„ ì‚¬ì§„ê´€": (100, 100),
    "ë¼ì´ë¸Œë“œë¡œì‰": (250, 250),

    # ================= [Aì¡´] =================
    "A-100 1989 PALETTE": (100, 750),
    "A-101 í´ë¦½ì•„íŠ¸ì½”ë¦¬ì•„": (100, 760),
    "A-104 ë¼ë‹ˆë””ìì¸": (110, 750),
    "A-111 ì†ŒëŸ‰": (110, 760),
    "A-114 ë©”ì´ë§ˆíŠ¸": (120, 750),
    "A-118 ë””ì§€": (120, 760),
    "A-121 í˜ì´í¼": (130, 750),
    "A-124 ìì´ì–¸íŠ¸ì•„ì´": (130, 760),
    "A-128 í™ˆì–´ìŠ¤": (140, 750),
    "A-130 êµ¿ì›Œí¬": (140, 760),
    "A-132 í•˜í•¨ìŠ¤íŠœë””ì˜¤": (150, 750),

    # ================= [Bì¡´] =================
    "B-104 ê³ ì–‘ì´ë‹¤ë°©": (200, 750),
    "B-110 ì§€ë‹ˆìš”ë‹ˆ": (200, 760),
    "B-111 TTIPCY": (210, 750),
    "B-112 ìë¯¼í•´": (210, 760),
    "B-115 ì§€ì§€(MONZIZI)": (220, 750),
    "B-120 ë¸”ë£¨ì¸ ": (220, 760),
    "B-124 íˆ¬ìœ ëŸ½ë¯¸": (230, 750),
    "B-126 ì„¤ê¸°ì¼ëŸ¬ìŠ¤íŠ¸": (230, 760),
    "B-131 ë¹ˆì§‘": (240, 750),
    "B-201 Gimm": (250, 750),
    "B-218 ì´ˆëª©ì í™”": (250, 760),
    "B-219 í˜ë…€ë¦¬ë‹ˆ": (260, 750),
    "B-220 ë†ë†ì´": (260, 760),
    "B-221 í•œë¦¼ì‚¬": (270, 750),
    "B-224 í‚¤íŒ…ì œì´": (270, 760),

    # ================= [Cì¡´] =================
    "C-100 ìœ¤ì¡°ìœ ë¼": (300, 300),
    "C-103 ë¹„ëª¨ë¸ ìŠ¤íŠœë””ì˜¤": (300, 310),
    "C-104 ë‹¬ë¹›ê³°": (310, 300),
    "C-110 ë¶“í„°ì¹˜": (310, 310),
    "C-111 MachiK": (320, 300),
    "C-112 MIND FAMILY": (320, 310),
    "C-113 yaoyao": (330, 300),
    "C-115 inkpainting": (330, 310),
    "C-118 ì¿„ì½”(Kyoko)": (340, 300),
    "C-120 ì‚°ê·¸ë¦¬ë©”": (340, 310),
    "C-125 ê¹€íš¨ì •": (350, 300),
    "C-129 ì–‘íŒŒ": (350, 310),
    "C-130 ìœ„ì‹œìœ ": (360, 300),
    "C-131 ì˜¤ë¬˜": (360, 310),
    "C-200 ë§ë¡œí•˜ê³°ê³°": (370, 300),
    "C-208 6-208": (370, 310),
    "C-211 ê´‘íƒœ": (380, 300),
    "C-214 ê¹€ì´ë„¤": (380, 310),
    "C-218 ê¸°ì˜¨ìŠ¤íŠœë””ì˜¤": (390, 300),
    "C-219 ë¦¬í„°í”„ë¡¤ëŸ¬ë¸Œë“œ": (390, 310),
    "C-220 ì˜´ì¦ˆ": (400, 300),
    "C-231 í”¼í”¼": (400, 310),

    # ================= [Dì¡´] =================
    "D-100 ë§ì•ì´ ë””ìì¸": (500, 400),
    "D-101 ë¯¸ì•¼ì˜¤íƒ€ìš´": (500, 410),
    "D-103 ì œë‹ˆë¹Œë¦¬ì§€": (510, 400),
    "D-107 ë°•ì‚°": (510, 410),
    "D-110 ë¡œìŠ¤íŠ¸ì•¤íŒŒìš´ë“œ": (520, 400),
    "D-115 ìŠ¤íŠœë””ì˜¤ ë‹¤ëŒ": (520, 410),
    "D-118 DONEARTH": (530, 400),
    "D-123 ì˜ë„ë¦¬": (530, 410),
    "D-124 íƒ€ë…¸ì›”ë“œ": (540, 400),
    "D-128 ë°”ì´ê³ ëŒ€": (540, 410),
    "D-130 ê·¸ëŸ¬ëŠ” ì¸": (550, 400),
    "D-201 113": (550, 410),
    "D-213 Straycat tarot": (560, 400),
    "D-214 Sleepybere": (560, 410),
    "D-215 The 3rd Daughter": (570, 400),
    "D-216 ë‚˜ëª¨ë„": (570, 410),
    "D-219 ë¨¸ë¦¬": (580, 400),
    "D-224 ëª¨ë„ë¦¬ ìŠ¤íŠœë””ì˜¤": (580, 410),
    "D-232 Draft.apics": (590, 400),

    # ================= [Fì¡´] =================
    "F-101 ì½”ì½”ì˜ ê·¸ë¦¼ê³µê°„": (700, 300),
    "F-102 ê³ ë™ì„±": (700, 310),
    "F-103 í˜¸ë‘": (710, 300),
    "F-104 ì•„ë¼ë¹…ìŠ¤": (710, 310),
    "F-106 í”„ë Œì¦ˆ": (720, 300),
    "F-107 ë‹´ì¥ì•„ë˜": (720, 310),
    "F-108 ê³ ë¼ë‹ˆ": (730, 300),
    "F-114 ë‹¬ë‹´": (730, 310),
    "F-115 í—ˆë‹¤ë§ˆë¦¬": (740, 300),
    "F-116 ëª¨ëª¨ì´í•˜ìš°ìŠ¤": (740, 310),
    "F-119 ì˜¤ê¸°í™˜": (750, 300),
    "F-120 êµ¬ë¦¬": (750, 310),
    "F-124 ë‹ˆì–´ë°”ì´ë””ì–´": (760, 300),
    "F-128 milky rapstar": (760, 310),
    "F-129 ëª¨ì„œë¦¬ ìŠ¤íŠœë””ì˜¤": (770, 300),
    "F-130 ì½”ìŠ¤ëª¨ ìµìŠ¤í”„ë ˆìŠ¤": (770, 310),
    "F-131 Rosemary Hill": (780, 300),
    "F-201 ì‹±í¬ìœ ìŠ¤íŠœë””ì˜¤": (780, 310),
    "F-203 ë“€ì›": (790, 300),
    "F-204 ë‘ë£¨ë­‰ì´ë‘ë”ì§€": (790, 310),
    "F-207 ë³µìí•˜ìš°ìŠ¤": (800, 300),
    "F-209 ë‹¨ì‹ì›": (800, 310),
    "F-211 ì  ë””ë””": (810, 300),
    "F-212 ì—°ë‘ì‹­": (810, 310),
    "F-213 ìš°ë‹¹íƒ•íƒ•ìŠ¤í† ì–´": (820, 300),
    "F-215 ë„ìˆœìƒí˜„": (820, 310),
    "F-220 ì ë™ì‚¬ë‹ˆ": (830, 300),
    "F-221 ë‹¤ëŒ": (830, 310),
    "F-223 ë‹¤ë¸”ë™": (840, 300),
    "F-224 ì§€ìš° ìŠ¤ë§ˆì¼": (840, 310),
    "F-226 ìŠ¤íŠœë””ì˜¤ í‘œë‹ˆ": (850, 300),
    "F-229 ë£¨ì´ì™€ì½”ì´ëˆ„": (850, 310),
    "F-231 Catist": (860, 300),

    # ================= [Gì¡´] =================
    "G-100 ì‡¼í‚¹í•‘í¬ë¡œì¦ˆ": (400, 600),
    "G-101 ìœ ìŠ¹": (400, 610),
    "G-111 ë„ì•„ì„¸": (410, 600),
    "G-112 ë™ì‹í’ˆì›": (410, 610),
    "G-114 ìš°ì—°ì² ": (420, 600),
    "G-118 ë°±êµ¬ì„±ìŠ¤íŠœë””ì˜¤": (420, 610),
    "G-120 ë‹›(Knit)": (430, 600),
    "G-121 2-121": (430, 610),
    "G-128 í•˜ì´ë³¼ë£¨ìœ ": (440, 600),
    "G-129 Ideal Idea": (440, 610),
    "G-130 ë ˆë“œì´ì–´ìŠ¤í´ëŸ½": (450, 600),
    "G-200 Thustimesu": (450, 610),
    "G-201 ì½œë¦¬ìŠ¤íŠœë””ì˜¤": (460, 600),
    "G-214 í† ë¼ ê³¼ ì¹œêµ¬ë“¤": (460, 610),
    "G-215 í•˜ìŠˆë°´ë“œ": (470, 600),
    "G-223 ì•™ê³ ë¼ë¡œë¼": (470, 610),
    "G-228 CEE": (480, 600),
    "G-229 dawnitive wave": (480, 610),
    "G-231 ì‚¬ë¦¬ì•ˆë£¨ë‹ˆ": (490, 600),

    # ================= [Hì¡´] =================
    "H-100 ì£¼ìŠ¤": (600, 200),
    "H-101 ì•ˆë…•, ë§ë¡œí•˜": (600, 210),
    "H-102 ë¦¬ë…¸í”„ë Œì¦ˆ": (610, 200),
    "H-104 ë²¨ë¡œì´ë£¨": (610, 210),
    "H-107 ì¡°ê°": (620, 200),
    "H-110 ì¸„ë¦¬ì„œë": (620, 210),
    "H-112 ìœ êµê³°": (630, 200),
    "H-119 OHD": (630, 210),
    "H-120 ë°€í¬ë³‘ìŠ¤íŠœë””ì˜¤": (640, 200),
    "H-129 ë‹¤ë¼ë¯¸ë„¤": (640, 210),
    "H-130 ë‹¨ì£¼ìŠ¤í€˜ì–´": (650, 200),
    "H-133 studio som": (650, 210),
    "H-200 ë£¨ë£¨í”¼94": (660, 200),
    "H-201 ì±„ë³´ë¦¬": (660, 210),
    "H-202 ìŠ¤íŠœë””ì˜¤ë‹ˆëª¨": (670, 200),
    "H-203 íŒíƒ€í¬ë ˆ": (670, 210),
    "H-204 ê¹€ë³´ë¯¸": (680, 200),
    "H-208 ìˆ˜í”¼": (680, 210),
    "H-211 ë””ì–´í´ë¦¬": (690, 200),
    "H-212 ì„¸ë¼ë² ì–´": (690, 210),
    "H-216 ì „": (700, 200),
    "H-219 From Gyeol": (700, 210),
    "H-220 ì‚°ë½€": (710, 200),
    "H-223 ê³µì§„ì–´íŠ¸": (710, 210),
    "H-225 ì•„ë“": (720, 200),
    "H-228 ì—°ë©”ì´ë“œ": (720, 210),
    "H-230 íí‹°ì§€íŒŒì‹¤": (730, 200),
    "H-231 í—ˆë‹¤ë§ˆë¦¬": (730, 210),

    # ================= [Jì¡´] =================
    "J-102 ì°¨ë¦¬": (100, 500),
    "J-103 ìŠ¤ëˆ„ì¦ˆí‚¤ì¦ˆ": (100, 510),
    "J-106 Netty Lee": (110, 500),
    "J-112 ì—ì´ë“œë°”ì´ìš©": (110, 510),
    "J-115 ìŠ¤ë””": (120, 500),
    "J-120 ë°”ë‚˜ë°€ëŸ¬ìŠ¤íŠ¸": (120, 510),
    "J-124 EM, C": (130, 500),
    "J-125 ë‹ˆë“œ": (130, 510),
    "J-134 ë²”ìº£ì¸ ": (140, 500),
    "J-200 ë¸”ë™ë¼í„°": (140, 510),
    "J-201 ë”©êµ´": (150, 500),
    "J-202 ì¹´ë¼": (150, 510),
    "J-203 ë©”ì´ë§ˆíŠ¸": (160, 500),
    "J-204 ëšœë””ì–´ë¦¬": (160, 510),
    "J-208 ë¡ì‹œ(HOXIE)": (170, 500),
    "J-215 ì–´ë´¤êµ¬": (170, 510),
    "J-219 ë…ë‹¤í•™ë°©": (180, 500),
    "J-220 ìŠ¤íŠœë””ì˜¤ íë“€": (180, 510),
    "J-223 ë¹„íƒ€í¼í¼": (190, 500),
    "J-226 í•˜ë¦¬ì»¤í”¼": (190, 510),
    "J-229 ì ¤ë¦¬ë¶€ (JeliRivu)": (200, 500),
    "J-231 ê°œêµ¬ë¦¬ë¼ë¯¸": (200, 510),

    # ================= [Kì¡´] =================
    "K-101 ì½”ë¦¬ì•„": (900, 100),
    "K-104 ì˜¤ë•ìŠ¤íŠœë””ì˜¤": (900, 110),
    "K-106 ë¼ìš´ë“œë£¨í”„": (910, 100),
    "K-107 ìœ¨ë¬´ìƒìƒ": (910, 110),
    "K-108 ë¯¸ë‰´": (920, 100),
    "K-121 ì•„ì„êµ¬ë¥´ë¯¸": (920, 110),
    "K-128 ë°©ì¥¬": (930, 100),
    "K-130 ìš°ê±°ì§„": (930, 110),
    "K-201 ë³„íˆì¸ê³µì—¬": (940, 100),
    "K-204 ë§ˆëŠ„ì´": (940, 110),
    "K-206 ë§ìˆœë§ˆì¼“": (950, 100),
    "K-207 ë¹„ì•„ í¬ë˜í”„íŠ¸": (950, 110),
    "K-208 í¬ë¬¼ë•ìƒì ": (960, 100),
    "K-211 ë¸ŒíŒ¨": (960, 110),
    "K-214 ë¬˜ì¹´ìƒì‹¬": (970, 100),
    "K-220 ë§ˆëƒ¥": (970, 110),
    "K-223 ì˜ê·¸ë¦¬ì¦ˆ": (980, 100),
    "K-225 ë³´ë‹¤ìŠ¤í˜ì´ìŠ¤": (980, 110),
    "K-229 ì•¼ìŒíŒ¬": (990, 100),
    "K-231 ì´íŠ¸ë§¨": (990, 110),
    "K-235 ê¹€ì¤‘ì´": (990, 120),

    # ================= [Lì¡´] =================
    "L-100 í•˜ë‚˜ë‹˜": (50, 700),
    "L-101 ì‹¬ëƒ¥ì¦ˆ": (50, 710),
    "L-103 ë‹ˆë²„ìŠ¤": (60, 700),
    "L-107 í˜êµë¯¸": (60, 710),
    "L-109 ì½©ë™ì´ë„¤": (70, 700),
    "L-112 ë£¨ëª…ì˜ ê·¸ë¦¼ë“¤": (70, 710),
    "L-113 ë©œíŒ…ì»·": (80, 700),
    "L-120 ë¦¬ì–¼(ì„œì˜ˆë¦°)": (80, 710),
    "L-123 í‘¸ì–´ì˜¤": (90, 700),
    "L-131 ê³ ì„ íƒ€": (90, 710),
    "L-207 ë¯¼íƒ€": (100, 700),
    "L-215 ë‹¤ê·¸ë¦¼": (100, 710),
    "L-220 ëª¨ì²´í† ë¦¬": (110, 700),
    "L-224 í¬ë¦¬ë¯¸ë°€í‚¤": (110, 710),

    # ================= [Mì¡´] =================
    "M-101 ë¬¸í•™ ì„­": (250, 900),
    "M-102 ì•„ì•¼ë„¤": (250, 910),
    "M-103 ë”í‘¸ë¦¬ ë¹Œë¦¬ì§€": (260, 900),
    "M-106 ì½”ì½”ì˜ ê·¸ë¦¼ê³µê°„": (260, 910),
    "M-107 ë„¤": (270, 900),
    "M-110 ì‹œì½”ë¥´ ë™ì‚¬ë¬´ì†Œ": (270, 910),
    "M-115 ì´í™”ì—¬ëŒ€ë³‘ì„¤ë¯¸ë””ì–´ê³ ë“±í•™êµ": (280, 900),
    "M-118 ì˜¤ëšì´ìˆ²": (280, 910),
    "M-120 ë§ë¡œí•˜ê³°ê³°": (290, 900),
    "M-121 ì²˜ë¦¬ë¸”ë¡œ": (290, 910),
    "M-126 ìƒì ": (300, 900),
    "M-128 L-113": (300, 910),
    "M-129 ëª¨ë“ ": (310, 900),
    "M-130 ë¯¸ëª¨": (310, 910),
    "M-131 ëŸ¬ë¸Œí¬ë ˆì„¼íŠ¸": (320, 900),
    "M-201 ì€ nuleun": (320, 910),
    "M-204 ë…¸ë² ì§€ì§€ì—": (330, 900),
    "M-206 ë°ë‹¤í•¨ ê·¸ë¦¼ì¼ê¸°": (330, 910),
    "M-207 êµ¬ëƒ¥ì´": (340, 900),
    "M-211 ì•„ë¥´ë² ": (340, 910),
    "M-212 ìœ¼ë‹ˆì„¸ì‘ì—…ì‹¤": (350, 900),
    "M-214 Bookí•´í”¼í•¸ë””": (350, 910),
    "M-215 nunnu": (360, 900),
    "M-216 ê¾¸ê¾¸ë§Œë“¤ê¸°": (360, 910),
    "M-220 ë¦¬í¬í¬": (370, 900),
    "M-225 ë¯€": (370, 910),
    "M-226 ìœ ì–´íˆ¬ë°ì´": (380, 900),
    "M-228 ì±„ë„": (380, 910),
    "M-229 Gunwoo Frierids": (390, 900),
    "M-230 ì‚¬ë¦¬ì•ˆë£¨ë‹ˆ": (390, 910),

    # ================= [Oì¡´] =================
    "O-101 í‚¤ìŠ¤í‹±ë¹Œë¦¬ì§€": (850, 800),
    "O-102 zeeky": (850, 810),
    "O-104 ê°ì„±ê³µì‘ì†Œ": (860, 800),
    "O-110 ëšœëª¨ë„¤": (860, 810),
    "O-111 ë™ì‹í’ˆì›": (870, 800),
    "O-112 ê°œë°•í•˜": (870, 810),
    "O-113 KNOTKNOT": (880, 800),
    "O-114 í¬ì¹´í¬ì¹´": (880, 810),
    "O-115 ìµœì—°ì§„": (890, 800),
    "O-120 ê¹€ëª¨ì–‘êµ°": (890, 810),
    "O-121 7AM": (900, 800),
    "O-126 ë£¨ë§ˆ": (900, 810),
    "O-131 ë‹ˆì–´ë°”ì´ë””ì–´": (910, 800),
    "O-200 3ë¶„ìˆ˜ì±„ì´ˆìƒí™”": (910, 810),
    "O-201 ëƒ‰ì´ê³¨ê³¨": (920, 800),
    "O-203 ë…¸ë§ˆ": (920, 810),
    "O-210 ìŠ¤íŠœë””ì˜¤ ìª¼ë¬¼": (930, 800),
    "O-211 Bangkok Fair": (930, 810),
    "O-213 ë‹¨ë¹„ìŠ¤í˜ì´ìŠ¤": (940, 800),
    "O-215 íƒœë¦¼": (940, 810),
    "O-218 í‘¸í‚¤íí‹°": (950, 800),
    "O-220 ë‹¨í’": (950, 810),
    "O-221 ë„ì‹œì˜¤ë¸Œë“œë¦¼": (960, 800),
    "O-223 ìœ„í‹°í”„ë¼í‹°": (960, 810),
    "O-224 ë‹¤ë¼ìŠ¤íŠœë””ì˜¤": (970, 800),
    "O-225 ì°¨": (970, 810),
    "O-226 ëª¨ë˜ë³´ì´": (980, 800),
    "O-228 ì „ì…‹": (980, 810),
    "O-229 ë„¤ëª¨ì§„": (990, 800),
    "O-230 ìš”ìš”": (990, 810),
    "O-231 ì˜¬ë¦¬": (990, 820),

    # ================= [Pì¡´] =================
    "P-100 ì•¼ìš¸ì´ë¯¸ë‹¹": (600, 50),
    "P-101 ë””ì— í”¼ ë¶ìŠ¤í† ì–´": (610, 50),
    "P-103 ë§ˆíŠ¸": (620, 50),
    "P-108 ì§€ì—°": (630, 50),
    "P-111 ë°€í¬ë³‘ìŠ¤íŠœë””ì˜¤": (640, 50),
    "P-113 ì†Œë…€ ìœ ë‹ˆë²„ìŠ¤": (650, 50),
    "P-114 ë¦¬ë™ë„¤ì¹œêµ¬ë“¤": (660, 50),
    "P-115 CEE": (670, 50),
    "P-116 ì˜¤ë¶ˆ": (680, 50),
    "P-117 ë§ˆì˜¤ì•ˆ(ADAN)": (690, 50),
    "P-118 ì¦ˆ(ploppyz)": (700, 50),

    # ================= [Sì¡´] =================
    "S-101 ê³„ì›ì˜ˆëŒ€": (800, 200),
    "S-102 ê³„ì›ì˜ˆëŒ€ ìˆœìˆ˜ë¯¸ìˆ ": (800, 210),
    "S-104 ì´ë“¤ Yidle": (810, 200),
    "S-106 ë°¸íŠ¸ê¸€ë¼ìŠ¤": (810, 210),
    "S-107 ë§¤ì„œ ëƒ¥ì´": (820, 200),
    "S-108 KANGZI (ê°•ì§€)": (830, 200),
    "S-109 ë””ì•„íŠ¸82": (830, 210),
    "S-110 LJE": (840, 200),
    "S-114 í™ë¬´ì•„": (840, 210),
    "S-115 ë””ì•„ë”ì›”ë“œ": (850, 200),
    "S-117 ëª¨ë¦¬ Morn": (850, 210),
    "S-125 ì„œìš¸ì˜ˆìˆ ëŒ€í•™êµ": (860, 200),

    # ================= [Tì¡´] =================
    "T-001 í†¤ì–´ìŠ¤ (TOONUS)": (200, 800),
    "T-204 íˆ¬ìœ ëŸ½ë¯¸": (210, 800),

    # ================= [ë””ì €íŠ¸ ì¡´] =================
    "Dessert-01 ì•„ë¦¬ê°ì„±": (50, 400),
    "Dessert-02 ë¹„ë‹¨ìˆ˜ì ": (50, 410),
    "Dessert-03 í”Œë¼ì‰ë”ì¹˜": (60, 400),
    "Dessert-04 ë©”íƒˆíŠ¸": (60, 410),
    "Dessert-05 ë”ë¦¬ì–¼í‹°": (70, 400),
    "Dessert-06 ì¥¬ë‹ˆì¿ í‚¤": (70, 410),
    "Dessert-07 íŒŒíŒŒëˆ„ë£½ì§€": (80, 400),
    "Dessert-08 ë¶ˆëŸ‰": (80, 410),
    "Dessert-09 í”„ë¦¬ë¯¸ì—„ ì¿ í‚¤": (90, 400),
    "Dessert-10 ê¼¬ë§ˆë£¨ìœ¡í¬": (90, 410),
    "Dessert-11 ë‰´ìš•ì˜ ì €ìŠ¤íŠ¸ ì¿ í‚¤": (100, 400),
    "Dessert-12 ìˆœë‘ë¶€ì ¤ë¼ë˜": (100, 410),
    "Dessert-13 ê³¼ë°€ê³¼ì¦™ì ¤ë¦¬": (110, 400),
    "Dessert-14 ë©”íƒ€í”„ë ˆì‰¬": (110, 410),
    "Dessert-15 ë¹„ë‹¨ìˆ˜ì ": (120, 400),
    "Dessert-16 ì–¸ì œë‚˜ ì—¬ë¦„": (120, 410),
    "Dessert-17 ë‹¬ì¹˜ë‚˜": (130, 400),
    "Dessert-18 ì–‘í¬ë„¤": (130, 410),
    "ì†Œì†Œì»´": (350, 320)
}

# --- 3. í•µì‹¬ ì•Œê³ ë¦¬ì¦˜: A* ê²½ë¡œ íƒìƒ‰ + [NEW] ê°€ì¥ ê°€ê¹Œìš´ í†µë¡œ ì°¾ê¸° ---
@st.cache_data
def load_nav_mesh(image_path, grid_size=(100, 100)):
    try:
        img = Image.open(image_path).convert("L")
        img_resized = img.resize(grid_size)
        img_array = np.array(img_resized)
        # í°ìƒ‰(230 ì´ìƒ)ì€ í†µë¡œ(0), ë‚˜ë¨¸ì§€ëŠ” ë²½(1)
        grid = np.where(img_array > 230, 0, 1) 
        return grid, img.size
    except Exception as e:
        return None, None

def get_nearest_walkable_point(grid, start_node, max_radius=10):
    """
    [í•µì‹¬ ê¸°ëŠ¥] ì‹œì‘ì (ë¶€ìŠ¤)ì´ ë²½(1)ì´ë¼ë©´, ì£¼ë³€ì„ ë‚˜ì„ í˜•ìœ¼ë¡œ íƒìƒ‰í•´
    ê°€ì¥ ê°€ê¹Œìš´ í†µë¡œ(0) ì¢Œí‘œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    rows, cols = grid.shape
    
    # ì´ë¯¸ í†µë¡œë¼ë©´ ë°”ë¡œ ë°˜í™˜
    if grid[start_node[0]][start_node[1]] == 0:
        return start_node
        
    # BFS íƒìƒ‰ (ê°€ì¥ ê°€ê¹Œìš´ ê³³ë¶€í„° ì°¾ê¸° ìœ„í•´)
    queue = deque([start_node])
    visited = set([start_node])
    
    # ìƒí•˜ì¢Œìš° ë° ëŒ€ê°ì„  íƒìƒ‰
    directions = [(-1,0), (1,0), (0,-1), (0,1), (-1,-1), (-1,1), (1,-1), (1,1)]
    
    while queue:
        curr_r, curr_c = queue.popleft()
        
        # í†µë¡œ ë°œê²¬!
        if grid[curr_r][curr_c] == 0:
            return (curr_r, curr_c)
            
        # ë²”ìœ„ ì œí•œ (ë„ˆë¬´ ë©€ë¦¬ ì°¾ì§€ ì•Šë„ë¡)
        if abs(curr_r - start_node[0]) > max_radius or abs(curr_c - start_node[1]) > max_radius:
            continue
            
        for dr, dc in directions:
            nr, nc = curr_r + dr, curr_c + dc
            if 0 <= nr < rows and 0 <= nc < cols and (nr, nc) not in visited:
                visited.add((nr, nc))
                queue.append((nr, nc))
                
    return None # ëª» ì°¾ìŒ

def heuristic(a, b):
    return np.sqrt((b[0] - a[0]) ** 2 + (b[1] - a[1]) ** 2)

def astar(array, start, goal):
    neighbors = [(0,1),(0,-1),(1,0),(-1,0)]
    close_set = set()
    came_from = {}
    g_score = {start: 0}
    f_score = {start: heuristic(start, goal)}
    oheap = []

    heapq.heappush(oheap, (f_score[start], start))

    while oheap:
        current = heapq.heappop(oheap)[1]

        if current == goal:
            data = []
            while current in came_from:
                data.append(current)
                current = came_from[current]
            return data[::-1]

        close_set.add(current)
        for i, j in neighbors:
            neighbor = current[0] + i, current[1] + j
            tentative_g_score = g_score[current] + 1
            if 0 <= neighbor[0] < array.shape[0]:
                if 0 <= neighbor[1] < array.shape[1]:
                    if array[neighbor[0]][neighbor[1]] == 1:
                        continue
                else: continue
            else: continue
            if neighbor in close_set and tentative_g_score >= g_score.get(neighbor, 0):
                continue
            if  tentative_g_score < g_score.get(neighbor, 0) or neighbor not in [i[1] for i in oheap]:
                came_from[neighbor] = current
                g_score[neighbor] = tentative_g_score
                f_score[neighbor] = tentative_g_score + heuristic(neighbor, goal)
                heapq.heappush(oheap, (f_score[neighbor], neighbor))
    return None

# --- 4. ê²€ìƒ‰ ë„ìš°ë¯¸ í•¨ìˆ˜ ---
def find_target(keyword):
    if not keyword: return None
    keyword = keyword.lower().replace("-", "").replace(" ", "")
    keyword_s = keyword.replace("5", "s")
    keyword_o = keyword.replace("0", "o")
    
    matches = []
    for key in BOOTH_LOCATIONS.keys():
        key_clean = key.lower().replace("-", "").replace(" ", "")
        if (keyword in key_clean) or (keyword_s in key_clean) or (keyword_o in key_clean):
            matches.append(key)
    
    matches.sort(key=len)
    return matches[0] if matches else None

# --- 5. ë©”ì¸ UI ---
col_head1, col_head2 = st.columns([3, 1])
with col_head1:
    st.markdown("<h1 class='main-header'>ğŸ¨ SIK 2025 AI ë‚´ë¹„ê²Œì´ì…˜</h1>", unsafe_allow_html=True)
with col_head2:
    admin_mode = st.checkbox("ê´€ë¦¬ì ëª¨ë“œ (ì¢Œí‘œë”°ê¸°)")

img_path = "sik_floor_plan.jpg"
try:
    original_image = Image.open(img_path)
    aspect_ratio = original_image.height / original_image.width
    GRID_W = 100
    GRID_H = int(GRID_W * aspect_ratio)
    grid_map, original_size = load_nav_mesh(img_path, grid_size=(GRID_W, GRID_H))
except FileNotFoundError:
    st.error("âš ï¸ 'sik_floor_plan.jpg' íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
    st.stop()

# --- ê¸°ëŠ¥: ê´€ë¦¬ì ëª¨ë“œ ---
if admin_mode:
    st.info("ğŸ‘‡ ì§€ë„ì—ì„œ ë¶€ìŠ¤ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ë©´ ì •í™•í•œ ì¢Œí‘œë¥¼ ë”¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    value = streamlit_image_coordinates(original_image, key="pil")
    if value:
        x, y = value['x'], value['y']
        st.markdown(f"""
        <div class='coord-box'>
            ğŸ“ í´ë¦­í•œ ì¢Œí‘œ: <b>({x}, {y})</b><br>
            ìœ„ ì½”ë“œì˜ <code>BOOTH_LOCATIONS</code>ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.
        </div>
        """, unsafe_allow_html=True)
        draw = ImageDraw.Draw(original_image)
        draw.ellipse((x-10, y-10, x+10, y+10), fill="red", outline="white", width=3)
        st.image(original_image, caption="ì„ íƒëœ ìœ„ì¹˜")

# --- ê¸°ëŠ¥: ë‚´ë¹„ê²Œì´ì…˜ ëª¨ë“œ ---
else:
    with st.form("nav"):
        c1, c2 = st.columns(2)
        start_txt = c1.text_input("ì¶œë°œì§€", placeholder="ì˜ˆ: ì¶œì…êµ¬")
        end_txt = c2.text_input("ëª©ì ì§€", placeholder="ì˜ˆ: ì†Œì†Œì»´, C-118")
        btn = st.form_submit_button("ê¸¸ì°¾ê¸° ğŸš€")
    
    if btn:
        s_key = find_target(start_txt)
        e_key = find_target(end_txt)
        
        if not s_key or not e_key:
            st.error("ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
        else:
            st.success(f"ê²½ë¡œ íƒìƒ‰: **{s_key}** â¡ **{e_key}**")
            
            sx, sy = BOOTH_LOCATIONS[s_key]
            ex, ey = BOOTH_LOCATIONS[e_key]
            
            # ê·¸ë¦¬ë“œ ì¢Œí‘œ ë³€í™˜
            scale_x = GRID_W / original_size[0]
            scale_y = GRID_H / original_size[1]
            grid_start_raw = (int(sy * scale_y), int(sx * scale_x))
            grid_end_raw = (int(ey * scale_y), int(ex * scale_x))
            
            # [NEW] ë²½(ë¶€ìŠ¤)ì— ì¢Œí‘œê°€ ìˆë‹¤ë©´, ê°€ì¥ ê°€ê¹Œìš´ í†µë¡œë¡œ 'ìŠ¤ë‚´í•‘(Snapping)'
            grid_start = get_nearest_walkable_point(grid_map, grid_start_raw)
            grid_end = get_nearest_walkable_point(grid_map, grid_end_raw)
            
            if not grid_start or not grid_end:
                 st.error("ì£¼ë³€ì— í†µë¡œê°€ ì—†ìŠµë‹ˆë‹¤. ë§µì´ ë„ˆë¬´ ì–´ë‘¡ê±°ë‚˜ ì¢Œí‘œê°€ ì™„ì „íˆ ë§‰í˜€ìˆìŠµë‹ˆë‹¤.")
            else:
                with st.spinner("AIê°€ í†µë¡œë¥¼ ë”°ë¼ ê²½ë¡œë¥¼ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤..."):
                    path = astar(grid_map, grid_start, grid_end)
                
                if path:
                    draw = ImageDraw.Draw(original_image)
                    real_path = []
                    for py, px in path:
                        real_path.append((int(px / scale_x), int(py / scale_y)))
                    
                    if len(real_path) > 1:
                        draw.line(real_path, fill="#FF007F", width=6)
                    
                    # ë§ˆì»¤: ì›ë˜ ë¶€ìŠ¤ ìœ„ì¹˜ì— ì°ì–´ì¤Œ (ì‚¬ìš©ì í¸ì˜)
                    r = 15
                    draw.ellipse((sx-r, sy-r, sx+r, sy+r), fill="#00C853", outline="white", width=3)
                    draw.ellipse((ex-r, ey-r, ex+r, ey+r), fill="#FF0000", outline="white", width=3)
                    st.image(original_image, use_container_width=True)
                else:
                    st.warning("ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í†µë¡œê°€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŒ)")
